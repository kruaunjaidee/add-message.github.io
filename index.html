<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Line CRUD App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Inter', sans-serif;
        }
        .canva-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .canva-card:hover {
            transform: translateY(-5px);
        }
        .modal {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
            border-radius: 1rem;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .table-row:hover {
            background-color: #e0f2fe;
            cursor: pointer;
        }
        .type-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            color: white;
            font-size: 0.875rem;
        }
        textarea {
            color: #f97316;
        }
        .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #4b5563;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-btn:hover {
            color: #ef4444;
        }
        #formModal .modal-content {
            width: 100%;
            max-width: 48rem;
            height: auto;
            min-height: 28rem;
            margin: 0 1rem;
        }
        @media (max-width: 640px) {
            #formModal .modal-content {
                max-width: 100%;
                margin: 0;
                border-radius: 1rem;
            }
        }
        #modal .modal-content, #previewModal .modal-content {
            max-width: 45rem;
            height: auto;
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center bg-gradient-to-r from-red-500 to-orange-500 text-transparent bg-clip-text mb-6"><i class="fas fa-robot fa-shake mr-2"></i>Bot Line Management</h1>
        
        <!-- Chart -->
        <div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-6">
            <div class="canva-card p-6">
                <h2 class="text-xl font-semibold text-indigo-700 mb-4">Type Distribution</h2>
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <!-- Table Card -->
        <div class="canva-card p-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-4 sm:space-y-0">
                <h2 class="text-xl font-semibold text-indigo-700">List Of Messages</h2>
                <div class="flex items-center space-x-4 w-full sm:w-auto">
                    <input id="searchInput" type="text" placeholder="Search by intent..." class="w-full sm:w-64 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button id="addButton" class="bg-gradient-to-r from-green-500 to-teal-500 text-white p-2 rounded-lg hover:from-green-600 hover:to-teal-600 transition">Add New</button>
                </div>
            </div>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-blue-100">
                        <th class="p-2 text-left text-orange-600">ID</th>
                        <th class="p-2 text-left text-orange-600">Intent</th>
                        <th class="p-2 text-left text-orange-600">Type</th>
                        <th class="p-2 text-left text-orange-600">Actions</th>
                    </tr>
                </thead>
                <tbody id="botLineTable"></tbody>
            </table>
        </div>

        <!-- Form Modal -->
        <div id="formModal" class="fixed inset-0 hidden modal flex items-center justify-center">
            <div class="modal-content px-6 py-6">
                <button class="close-btn" onclick="document.getElementById('formModal').classList.add('hidden')">&times;</button>
                <h2 id="formTitle" class="text-xl font-semibold text-indigo-700 mb-4">Add/Edit Bot Line</h2>
                <form id="botLineForm" class="space-y-4">
                    <input type="hidden" id="id">
                    <div>
                        <label class="block text-sm font-medium text-orange-600">Intent</label>
                        <input type="text" id="intent" required class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-orange-600">Type</label>
                        <select id="type" required class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="TEXT">TEXT</option>
                            <option value="IMAGE">IMAGE</option>
                            <option value="VIDEO">VIDEO</option>
                            <option value="FLEX">FLEX</option>
                            <option value="TEMPLATE">TEMPLATE</option>
                            <option value="IMAGEMAP">IMAGEMAP</option>
                            <option value="AUDIO">AUDIO</option>
                            <option value="STICKER">STICKER</option>
                            <option value="LOCATION">LOCATION</option>
                            <option value="FILE">FILE</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-orange-600">Content</label>
                        <textarea id="content" required rows="4" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-orange-600">Preview</label>
                        <textarea id="preview" rows="4" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-orange-600">Place</label>
                        <input type="text" id="place" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-orange-600">Address</label>
                        <input type="text" id="address" class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white p-2 rounded-lg hover:from-red-600 hover:to-orange-600 transition">Save</button>
                    </div>
                </form>
                <button id="closeFormModal" class="mt-4 w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white p-2 rounded-lg hover:from-gray-600 hover:to-gray-700 transition">Close</button>
            </div>
        </div>

        <!-- Details Modal -->
        <div id="modal" class="fixed inset-0 hidden modal flex items-center justify-center">
            <div class="modal-content p-6">
                <button class="close-btn" onclick="document.getElementById('modal').classList.add('hidden')">&times;</button>
                <h2 class="text-xl font-semibold text-indigo-700 mb-4">Bot Line Details</h2>
                <div id="modalContent" class="space-y-4"></div>
                <button id="closeModal" class="mt-4 w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white p-2 rounded-lg hover:from-gray-600 hover:to-gray-700 transition">Close</button>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="fixed inset-0 hidden modal flex items-center justify-center">
            <div class="modal-content p-6">
                <button class="close-btn" onclick="document.getElementById('previewModal').classList.add('hidden')">&times;</button>
                <h2 class="text-xl font-semibold text-indigo-700 mb-4">Message Preview</h2>
                <div id="previewContent" class="border p-4 bg-white rounded mb-4"></div>
                <button id="closePreviewModal" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white p-2 rounded-lg hover:from-gray-600 hover:to-gray-700 transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        const edgeFunctionUrl = 'https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/add-messages';
        const supabaseApiKey = 'YOUR_SUPABASE_ANON_KEY'; // แทนที่ด้วย anon key จาก Supabase Dashboard
        const typeColors = {
            'TEXT': 'bg-green-500',
            'IMAGE': 'bg-blue-500',
            'VIDEO': 'bg-red-500',
            'FLEX': 'bg-yellow-500',
            'TEMPLATE': 'bg-purple-500',
            'IMAGEMAP': 'bg-indigo-500',
            'AUDIO': 'bg-pink-500',
            'STICKER': 'bg-orange-500',
            'LOCATION': 'bg-teal-500',
            'FILE': 'bg-cyan-500'
        };

        let typeChartInstance = null; // ตัวแปรสำหรับเก็บ instance ของ Chart.js

        async function fetchBotLines(search = '') {
            try {
                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseApiKey}`
                    },
                    body: JSON.stringify({ method: 'GET', data: { search } })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error('Response is not an array');
                }
                return data;
            } catch (error) {
                Toastify({ text: `Error fetching data: ${error.message}`, backgroundColor: 'red' }).showToast();
                return [];
            }
        }

        async function renderTable(search = '') {
            const data = await fetchBotLines(search);
            const tbody = document.getElementById('botLineTable');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'table-row border-b';
                const typeClass = typeColors[row.type] || 'bg-gray-500';
                tr.innerHTML = `
                    <td class="p-2 text-gray-800">${row.id}</td>
                    <td class="p-2 text-gray-800">${row.intent}</td>
                    <td class="p-2"><span class="type-badge ${typeClass}">${row.type}</span></td>
                    <td class="p-2">
                        <button onclick="editBotLine(${row.id})" class="text-blue-500 hover:underline">Edit</button>
                        <button onclick="deleteBotLine(${row.id})" class="text-red-500 hover:underline ml-2">Delete</button>
                        <button onclick="showPreview(${JSON.stringify(row)})" class="text-green-500 hover:underline ml-2">Preview</button>
                    </td>
                `;
                tr.onclick = () => showModal(row);
                tbody.appendChild(tr);
            });
            renderChart(data);
        }

        async function renderChart(data) {
            const types = ['TEXT', 'IMAGE', 'VIDEO', 'FLEX', 'TEMPLATE', 'IMAGEMAP', 'AUDIO', 'STICKER', 'LOCATION', 'FILE'];
            const counts = types.map(type => data.filter(row => row.type === type).length);
            const colors = ['#22c55e', '#3b82f6', '#ef4444', '#eab308', '#a855f7', '#6366f1', '#ec4899', '#f97316', '#14b8a6', '#06b6d4'];
            const ctx = document.getElementById('typeChart').getContext('2d');
            
            // ทำลายกราฟเก่าถ้ามี
            if (typeChartInstance) {
                typeChartInstance.destroy();
                typeChartInstance = null;
            }

            // สร้างกราฟใหม่
            typeChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: types,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors
                    }]
                },
                options: { responsive: true }
            });
        }

        function showModal(row) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            const typeClass = typeColors[row.type] || 'bg-gray-500';
            modalContent.innerHTML = `
                <p><strong class="text-purple-600">ID:</strong> <span class="text-gray-800">${row.id}</span></p>
                <p><strong class="text-purple-600">Intent:</strong> <span class="text-gray-800">${row.intent}</span></p>
                <p><strong class="text-purple-600">Type:</strong> <span class="type-badge ${typeClass}">${row.type}</span></p>
                <p><strong class="text-purple-600">Content:</strong> <span class="text-gray-800">${row.content}</span></p>
                <p><strong class="text-purple-600">Preview:</strong> <span class="text-gray-800">${row.preview || '-'}</span></p>
                <p><strong class="text-purple-600">Place:</strong> <span class="text-gray-800">${row.place || '-'}</span></p>
                <p><strong class="text-purple-600">Address:</strong> <span class="text-gray-800">${row.address || '-'}</span></p>
            `;
            modal.classList.remove('hidden');
        }

        document.getElementById('closeModal').onclick = function() {
            document.getElementById('modal').classList.add('hidden');
        };

        function showPreview(row) {
            const previewModal = document.getElementById('previewModal');
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = '';
            let previewHtml = '';
            const mediaUrl = row.preview || row.content;
            switch (row.type) {
                case 'TEXT':
                    previewHtml = `<p class="text-gray-800">${row.content}</p>`;
                    break;
                case 'IMAGE':
                    previewHtml = `<img src="${mediaUrl}" alt="Image Preview" class="max-w-full h-auto">`;
                    break;
                case 'VIDEO':
                    previewHtml = `<video controls src="${mediaUrl}" class="max-w-full h-auto"></video>`;
                    break;
                case 'AUDIO':
                    previewHtml = `<audio controls src="${mediaUrl}"></audio>`;
                    break;
                case 'STICKER':
                    previewHtml = `<p class="text-gray-800">Sticker: ${row.content}</p>`;
                    break;
                case 'LOCATION':
                    previewHtml = `<p class="text-gray-800">Location: ${row.place || ''} - ${row.address || ''}</p>`;
                    break;
                case 'FILE':
                    previewHtml = `<a href="${mediaUrl}" target="_blank" class="text-blue-500 hover:underline">Download File</a>`;
                    break;
                case 'FLEX':
                case 'TEMPLATE':
                case 'IMAGEMAP':
                    previewHtml = `<pre class="whitespace-pre-wrap text-gray-800">${row.content}</pre>`;
                    break;
                default:
                    previewHtml = `<p class="text-gray-800">Preview not available for this type.</p>`;
            }
            previewContent.innerHTML = previewHtml;
            previewModal.classList.remove('hidden');
        }

        document.getElementById('closePreviewModal').onclick = function() {
            document.getElementById('previewModal').classList.add('hidden');
        };

        async function editBotLine(id) {
            try {
                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseApiKey}`
                    },
                    body: JSON.stringify({ method: 'GET_BY_ID', id: parseInt(id) })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
                }
                const data = await response.json();
                if (!data) {
                    throw new Error('No data returned for ID');
                }
                document.getElementById('id').value = data.id;
                document.getElementById('intent').value = data.intent || '';
                document.getElementById('type').value = data.type || 'TEXT';
                document.getElementById('content').value = data.content || '';
                document.getElementById('preview').value = data.preview || '';
                document.getElementById('place').value = data.place || '';
                document.getElementById('address').value = data.address || '';
                document.getElementById('formTitle').textContent = 'Edit Bot Line';
                document.getElementById('formModal').classList.remove('hidden');
            } catch (error) {
                Toastify({ text: `Error fetching record: ${error.message}`, backgroundColor: 'red' }).showToast();
            }
        }

        async function deleteBotLine(id) {
            if (confirm('Are you sure you want to delete this record?')) {
                try {
                    const response = await fetch(edgeFunctionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${supabaseApiKey}`
                        },
                        body: JSON.stringify({ method: 'DELETE', id: parseInt(id) })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
                    }
                    Toastify({ text: 'Record deleted successfully', backgroundColor: 'green' }).showToast();
                    await renderTable();
                } catch (error) {
                    Toastify({ text: `Error deleting record: ${error.message}`, backgroundColor: 'red' }).showToast();
                }
            }
        }

        document.getElementById('botLineForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = document.getElementById('id').value;
            const data = {
                intent: document.getElementById('intent').value,
                type: document.getElementById('type').value,
                content: document.getElementById('content').value,
                preview: document.getElementById('preview').value || null,
                place: document.getElementById('place').value || null,
                address: document.getElementById('address').value || null
            };
            const method = id ? 'PUT' : 'POST';
            try {
                const response = await fetch(edgeFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseApiKey}`
                    },
                    body: JSON.stringify({ method, data, id: id ? parseInt(id) : undefined })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
                }
                Toastify({ text: 'Record saved successfully', backgroundColor: 'green' }).showToast();
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                document.getElementById('formModal').classList.add('hidden');
                document.getElementById('botLineForm').reset();
                document.getElementById('id').value = '';
                await renderTable();
            } catch (error) {
                Toastify({ text: `Error saving record: ${error.message}`, backgroundColor: 'red' }).showToast();
            }
        };

        document.getElementById('addButton').onclick = function() {
            document.getElementById('botLineForm').reset();
            document.getElementById('id').value = '';
            document.getElementById('formTitle').textContent = 'Add Bot Line';
            document.getElementById('formModal').classList.remove('hidden');
        };

        document.getElementById('closeFormModal').onclick = function() {
            document.getElementById('formModal').classList.add('hidden');
        };

        document.getElementById('searchInput').addEventListener('input', function(e) {
            renderTable(e.target.value);
        });

        renderTable();
    </script>
</body>
</html>
